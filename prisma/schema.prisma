generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  AGENT
  BACKOFFICE
  ADMIN
  FINANCE
}

enum IntakeStatus {
  PENDING
  PHONE_ISSUED
  IN_EXECUTION
  NEEDS_MORE_INFO
  PENDING_EXTERNAL
  EXECUTION_DELAYED
  INACTIVE
  READY_FOR_APPROVAL
  APPROVED
  REJECTED
  PARTNERSHIP_ENDED
}

enum PlatformType {
  // Sports Betting (8)
  DRAFTKINGS
  FANDUEL
  BETMGM
  CAESARS
  FANATICS
  BALLYBET
  BETRIVERS
  BET365
  // Financial (3)
  BANK
  PAYPAL
  EDGEBOOST
}

enum PlatformStatus {
  NOT_STARTED
  PENDING_UPLOAD
  PENDING_REVIEW
  NEEDS_MORE_INFO
  PENDING_EXTERNAL
  VERIFIED
  REJECTED
  LIMITED
}

enum ToDoType {
  EXECUTION
  UPLOAD_SCREENSHOT
  PROVIDE_INFO
  PAYMENT
  PHONE_SIGNOUT
  PHONE_RETURN
  VERIFICATION
}

enum ToDoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum ExtensionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  // Client lifecycle
  APPLICATION_SUBMITTED
  PHONE_ISSUED
  PHONE_RETURNED
  PLATFORM_UPLOAD
  PLATFORM_STATUS_CHANGE
  TODO_CREATED
  TODO_COMPLETED
  STATUS_CHANGE
  DEADLINE_EXTENDED
  DEADLINE_MISSED
  APPROVAL
  REJECTION
  COMMENT
  KPI_IMPACT
  // Auth
  LOGIN
  LOGOUT
  // Financial
  TRANSACTION_CREATED
  SETTLEMENT_CREATED
  // User management
  USER_CREATED
  USER_UPDATED
  USER_DEACTIVATED
  // System
  CONFIG_CHANGED
  EXPORT
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INTERNAL_TRANSFER
  COMMISSION_PAYOUT
  FEE
  ADJUSTMENT
}

enum SettlementStatus {
  PENDING_REVIEW
  CONFIRMED
  REJECTED
}

// ============================================
// MODELS
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String? // null for OAuth users
  name         String
  role         UserRole
  phone        String?
  avatar       String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ── Hierarchy ──
  supervisorId    String?
  supervisor      User?    @relation("AgentHierarchy", fields: [supervisorId], references: [id])
  subordinates    User[]   @relation("AgentHierarchy")

  // ── Tier & Star Level ──
  tier            String   @default("rookie")
  starLevel       Int      @default(0)

  // ── Profile (for Agent Detail page) ──
  gender          String?
  dateOfBirth     DateTime?
  idNumber        String?
  idExpiry        DateTime?
  idDocument      String?
  ssn             String?
  citizenship     String?
  personalEmail   String?
  personalPhone   String?
  companyPhone    String?
  carrier         String?
  zelle           String?
  address         String?
  loginAccount    String?

  notifications     Notification[]     @relation("UserNotifications")

  agentClients      Client[]           @relation("AgentClients")
  assignedToDos     ToDo[]             @relation("AssignedToDos")
  createdToDos      ToDo[]             @relation("CreatedToDos")
  eventLogs         EventLog[]
  agentMetrics      AgentMetrics?
  phoneAssignments  PhoneAssignment[]
  applicationDrafts ApplicationDraft[]
  extensionRequests ExtensionRequest[] @relation("ExtensionRequests")
  extensionReviews  ExtensionRequest[] @relation("ExtensionReviews")
  fundMovements        FundMovement[]
  fundMovementReviews  FundMovement[] @relation("FundMovementReviewer")

  // ── Commission relations ──
  bonusPoolsAsCloser  BonusPool[]        @relation("BonusPoolCloser")
  bonusAllocations    BonusAllocation[]
  leadershipPayouts   LeadershipPayout[]

  // ── Transaction relations ──
  recordedTransactions Transaction[]     @relation("RecordedTransactions")

  // ── Closure relations ──
  closedClients     Client[]           @relation("ClosedClients")

  @@index([supervisorId])
  @@index([role])
  @@index([email])
}

model Client {
  id                 String           @id @default(cuid())
  firstName          String
  lastName           String
  email              String?
  phone              String?
  idNumber           String?
  idDocument         String?
  address            String?
  city               String?
  state              String?
  zipCode            String?
  country            String?
  questionnaire      String?
  applicationNotes   String?
  gmailAccount       String?
  gmailPassword      String?
  prequalCompleted   Boolean          @default(false)
  intakeStatus       IntakeStatus     @default(PENDING)
  statusChangedAt    DateTime         @default(now())
  complianceReview   String?
  complianceStatus   String?
  backgroundCheck    Boolean          @default(false)
  executionDeadline  DateTime?
  deadlineExtensions Int              @default(0)
  agentId            String
  agent              User             @relation("AgentClients", fields: [agentId], references: [id])
  platforms          ClientPlatform[]
  toDos              ToDo[]
  eventLogs          EventLog[]
  phoneAssignment    PhoneAssignment?
  earnings           Earning[]
  extensionRequests  ExtensionRequest[]
  fundMovementsFrom  FundMovement[]   @relation("FundMovementsFrom")
  fundMovementsTo    FundMovement[]   @relation("FundMovementsTo")
  bonusPool          BonusPool?
  transactions       Transaction[]

  // ── Partner ──
  partnerId          String?
  partner            Partner?         @relation("PartnerClients", fields: [partnerId], references: [id])

  // ── Closure ──
  closedAt           DateTime?
  closureReason      String?
  closureProof       String[]
  closedById         String?
  closedBy           User?            @relation("ClosedClients", fields: [closedById], references: [id])

  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([intakeStatus])
  @@index([agentId])
  @@index([partnerId])
  @@index([createdAt])
}

model ClientPlatform {
  id             String         @id @default(cuid())
  clientId       String
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platformType   PlatformType
  status         PlatformStatus @default(NOT_STARTED)
  username       String?
  accountId      String?
  screenshots    String[]
  reviewNotes    String?
  reviewedBy     String?
  reviewedAt     DateTime?
  externalId     String?
  externalStatus String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([clientId, platformType])
  @@index([status])
  @@index([platformType])
}

model ToDo {
  id             String        @id @default(cuid())
  title          String
  description    String?
  type           ToDoType
  status         ToDoStatus    @default(PENDING)
  priority       Int           @default(0)
  dueDate        DateTime?
  completedAt    DateTime?
  // Upload & extension tracking
  stepNumber     Int?
  platformType   PlatformType?
  extensionsUsed Int           @default(0)
  maxExtensions  Int           @default(3)
  screenshots    String[]
  // Relations
  clientId       String?
  client         Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignedToId   String?
  assignedTo     User?         @relation("AssignedToDos", fields: [assignedToId], references: [id])
  createdById    String
  createdBy      User          @relation("CreatedToDos", fields: [createdById], references: [id])
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([status])
  @@index([type])
  @@index([assignedToId])
  @@index([clientId])
  @@index([dueDate])
  @@index([platformType])
}

model EventLog {
  id          String    @id @default(cuid())
  eventType   EventType
  description String
  clientId    String?
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  metadata    Json?
  oldValue    String?
  newValue    String?
  createdAt   DateTime  @default(now())

  notifications     Notification[]

  @@index([clientId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation("UserNotifications", fields: [userId], references: [id])

  type        String
  title       String
  message     String
  link        String?

  eventLogId  String?
  eventLog    EventLog? @relation(fields: [eventLogId], references: [id])
  clientId    String?

  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([eventLogId])
}

model PhoneAssignment {
  id          String    @id @default(cuid())
  phoneNumber String
  deviceId    String?
  clientId    String?   @unique
  client      Client?   @relation(fields: [clientId], references: [id])
  agentId     String
  agent       User      @relation(fields: [agentId], references: [id])
  issuedAt    DateTime?
  signedOutAt DateTime?
  returnedAt  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([phoneNumber])
  @@index([agentId])
}

model AgentMetrics {
  id              String    @id @default(cuid())
  agentId         String    @unique
  agent           User      @relation(fields: [agentId], references: [id])
  totalClients    Int       @default(0)
  approvedClients Int       @default(0)
  rejectedClients Int       @default(0)
  delayCount      Int       @default(0)
  extensionCount  Int       @default(0)
  successRate     Float     @default(0)
  delayRate       Float     @default(0)
  periodStart     DateTime?
  periodEnd       DateTime?
  updatedAt       DateTime  @updatedAt

  @@index([agentId])
}

model Earning {
  id          String    @id @default(cuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id])
  amount      Decimal   @db.Decimal(10, 2)
  currency    String    @default("USD")
  description String?
  status      String    @default("pending")
  paidAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([clientId])
  @@index([status])
}

model FundAllocation {
  id          String   @id @default(cuid())
  name        String
  description String?
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  allocatedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ApplicationDraft {
  id        String   @id @default(cuid())
  formData  Json
  agentId   String
  agent     User     @relation(fields: [agentId], references: [id])
  clientId  String?
  phase     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([clientId])
}

model ExtensionRequest {
  id              String                 @id @default(cuid())
  clientId        String
  client          Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  requestedById   String
  requestedBy     User                   @relation("ExtensionRequests", fields: [requestedById], references: [id])
  reviewedById    String?
  reviewedBy      User?                  @relation("ExtensionReviews", fields: [reviewedById], references: [id])
  status          ExtensionRequestStatus @default(PENDING)
  reason          String
  requestedDays   Int                    @default(3)
  currentDeadline DateTime
  newDeadline     DateTime?
  reviewedAt      DateTime?
  reviewNotes     String?
  createdAt       DateTime               @default(now())

  @@index([clientId])
  @@index([status])
  @@index([requestedById])
}

model FundMovement {
  id           String   @id @default(cuid())

  // Transfer classification
  type         String // "internal" | "external"
  flowType     String // "same_client" | "different_clients" | "external"

  // Sender
  fromClientId String?
  fromClient   Client?  @relation("FundMovementsFrom", fields: [fromClientId], references: [id])
  fromPlatform String

  // Receiver
  toClientId   String?
  toClient     Client?  @relation("FundMovementsTo", fields: [toClientId], references: [id])
  toPlatform   String

  // Amount
  amount       Decimal  @db.Decimal(10, 2)
  currency     String   @default("USD")
  fee          Decimal? @db.Decimal(10, 2)

  // Transfer details
  method       String? // "zelle" | "wire" | "transfer" | null
  status       String   @default("completed") // "pending" | "completed"
  notes        String?

  // Settlement confirmation
  settlementStatus SettlementStatus @default(PENDING_REVIEW)
  reviewedById     String?
  reviewedBy       User?    @relation("FundMovementReviewer", fields: [reviewedById], references: [id])
  reviewedAt       DateTime?
  reviewNotes      String?

  // Audit
  recordedById String
  recordedBy   User     @relation(fields: [recordedById], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fromClientId])
  @@index([toClientId])
  @@index([recordedById])
  @@index([settlementStatus])
  @@index([createdAt])
}

// ── Per-client bonus pool ($400 per approved client) ──
model BonusPool {
  id                String            @id @default(cuid())
  clientId          String            @unique
  client            Client            @relation(fields: [clientId], references: [id])
  closerId          String
  closer            User              @relation("BonusPoolCloser", fields: [closerId], references: [id])

  totalAmount       Decimal           @db.Decimal(10, 2) @default(400)
  directAmount      Decimal           @db.Decimal(10, 2) @default(200)
  starPoolAmount    Decimal           @db.Decimal(10, 2) @default(200)

  totalSlices       Int               @default(4)
  sliceValue        Decimal           @db.Decimal(10, 2) @default(50)
  distributedSlices Int               @default(0)
  recycledSlices    Int               @default(0)
  status            String            @default("pending")

  hierarchySnapshot Json?

  allocations       BonusAllocation[]

  createdAt         DateTime          @default(now())

  @@index([closerId])
  @@index([status])
}

// ── Individual allocation from a pool ──
model BonusAllocation {
  id              String    @id @default(cuid())
  bonusPoolId     String
  bonusPool       BonusPool @relation(fields: [bonusPoolId], references: [id])
  agentId         String
  agent           User      @relation(fields: [agentId], references: [id])

  type            String
  slices          Int       @default(0)
  amount          Decimal   @db.Decimal(10, 2)
  starLevelAtTime Int

  status          String    @default("pending")
  paidAt          DateTime?
  payoutRef       String?

  createdAt       DateTime  @default(now())

  @@index([bonusPoolId])
  @@index([agentId])
  @@index([status])
}

// ── Leadership tier payouts (5★+ only) ──
model LeadershipPayout {
  id              String    @id @default(cuid())
  agentId         String
  agent           User      @relation(fields: [agentId], references: [id])

  type            String
  tier            String

  bonusAmount     Decimal?  @db.Decimal(10, 2)
  sharePercent    Decimal?  @db.Decimal(5, 2)
  periodStart     DateTime?
  periodEnd       DateTime?
  teamRevenue     Decimal?  @db.Decimal(12, 2)
  payoutAmount    Decimal?  @db.Decimal(10, 2)

  status          String    @default("pending")
  paidAt          DateTime?

  createdAt       DateTime  @default(now())

  @@index([agentId])
  @@index([tier])
  @@index([status])
}

// ── Append-only financial ledger ──
model Transaction {
  id              String          @id @default(cuid())
  type            TransactionType
  amount          Decimal         @db.Decimal(10, 2)
  currency        String          @default("USD")
  status          String          @default("completed")

  clientId        String?
  client          Client?         @relation(fields: [clientId], references: [id])
  platformType    PlatformType?
  fundMovementId  String?
  bonusPoolId     String?

  description     String?
  reference       String?
  documentUrl     String?

  recordedById    String
  recordedBy      User            @relation("RecordedTransactions", fields: [recordedById], references: [id])
  metadata        Json?

  createdAt       DateTime        @default(now())

  @@index([clientId])
  @@index([platformType])
  @@index([type])
  @@index([createdAt])
  @@index([recordedById])
  @@index([fundMovementId])
}

// ── Partners (external business entities that share in profits) ──
model Partner {
  id              String            @id @default(cuid())
  name            String
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  company         String?
  type            String            @default("referral")  // "referral" | "platform" | "investor" | "affiliate"
  status          String            @default("active")    // "active" | "inactive" | "suspended"
  notes           String?

  clients         Client[]          @relation("PartnerClients")
  profitShareRules ProfitShareRule[]
  profitShareDetails ProfitShareDetail[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([type])
}

// ── Profit sharing rules (defines how profits are split with partners) ──
model ProfitShareRule {
  id              String            @id @default(cuid())
  partnerId       String
  partner         Partner           @relation(fields: [partnerId], references: [id])

  name            String
  description     String?

  // Split configuration
  splitType       String            @default("percentage")  // "percentage" | "fixed" | "tiered"
  partnerPercent  Decimal?          @db.Decimal(5, 2)
  companyPercent  Decimal?          @db.Decimal(5, 2)
  fixedAmount     Decimal?          @db.Decimal(10, 2)

  // Applicability
  appliesTo       String            @default("all")         // "all" | "deposits" | "withdrawals" | "commissions"
  platformType    PlatformType?
  minAmount       Decimal?          @db.Decimal(10, 2)
  maxAmount       Decimal?          @db.Decimal(10, 2)

  // Fee deductions (taken before split)
  feePercent      Decimal?          @db.Decimal(5, 2)
  feeFixed        Decimal?          @db.Decimal(10, 2)

  status          String            @default("active")      // "active" | "inactive" | "draft"
  effectiveFrom   DateTime          @default(now())
  effectiveTo     DateTime?
  priority        Int               @default(0)

  details         ProfitShareDetail[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([partnerId])
  @@index([status])
  @@index([appliesTo])
}

// ── Transaction-level profit share tracking ──
model ProfitShareDetail {
  id              String           @id @default(cuid())
  partnerId       String
  partner         Partner          @relation(fields: [partnerId], references: [id])
  ruleId          String
  rule            ProfitShareRule  @relation(fields: [ruleId], references: [id])

  // Source transaction
  transactionId   String?
  fundMovementId  String?

  // Calculation breakdown
  grossAmount     Decimal          @db.Decimal(10, 2)
  feeAmount       Decimal          @db.Decimal(10, 2) @default(0)
  netAmount       Decimal          @db.Decimal(10, 2)
  partnerAmount   Decimal          @db.Decimal(10, 2)
  companyAmount   Decimal          @db.Decimal(10, 2)

  description     String?
  status          String           @default("pending")  // "pending" | "approved" | "paid"
  paidAt          DateTime?

  createdAt       DateTime         @default(now())

  @@index([partnerId])
  @@index([ruleId])
  @@index([status])
  @@index([createdAt])
}
